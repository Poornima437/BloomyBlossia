{% extends "user_profile/base_sidebar.html" %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Checkout</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', sans-serif;
        }
        .checkout-container {
            max-width: 1200px;
            margin: 40px auto;
            background: #fdfdfd;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        }
        .form-group label {
            font-weight: 600;
        }
        .order-summary {
            background-color: #f1f1f1;
            padding: 20px;
            border-radius: 6px;
            margin-top: 20px;
        }
        .order-summary h5 {
            margin-bottom: 20px;
        }
        .place-order-btn {
            width: 100%;
            margin-top: 20px;
        }
        .is-invalid {
            border: 1px solid red !important;
        }
        .text-danger {
            font-size: 0.85rem;
        }
        .address-card {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .address-card:hover {
            border-color: #17a2b8;
            background-color: #f0f9ff;
        }
        .address-card.selected {
            border-color: #17a2b8;
            background-color: #e0f5f9;
        }
        .address-card input[type="radio"] {
            width: 18px;
            height: 18px;
            margin-right: 12px;
        }
        .address-type-badge {
            display: inline-block;
            padding: 3px 10px;
            background-color: #17a2b8;
            color: white;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: 8px;
        }
        .add-address-btn {
            border: 2px dashed #17a2b8;
            background: transparent;
            color: #17a2b8;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 20px;
        }
        .add-address-btn:hover {
            background-color: #e0f5f9;
        }
        .address-form-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .back-to-cart {
            color: #17a2b8;
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .back-to-cart:hover {
            color: #138496;
            text-decoration: none;
        }
        .back-to-cart svg {
            margin-right: 8px;
        }
    </style>
</head>
<body>
<div class="container mt-5 mb-5">
    <div class="checkout-container p-4 bg-white rounded shadow">
        <!-- Back to Cart Button -->
        <a href="{% url 'cart:cart' %}" class="back-to-cart">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Cart
        </a>

        <h3 class="mb-4">Checkout</h3>

        {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            </div>
        {% endfor %}
        {% endif %}
        
        <form id="checkoutForm" method="post" action="{% url 'orders:checkout' %}">
            {% csrf_token %}
            <input type="hidden" name="action" id="formAction" value="place_order">
            
            <div class="row">
                <!-- Left Column: Address & Payment -->
                <div class="col-md-7">
                    <h5 class="mb-3">Shipping Address</h5>
                    
                    <!-- Display Saved Addresses -->
                    {% if addresses %}
                        <div id="savedAddresses">
                            {% for address in addresses %}
                            <div class="address-card {% if address.is_default %}selected{% endif %}" onclick="selectAddress(this, {{ address.address_id }})">
                                <label class="d-flex align-items-start mb-0" style="cursor: pointer;">
                                    <input type="radio" name="selected_address" value="{{ address.address_id }}" {% if address.is_default %}checked{% endif %}>
                                    <div class="flex-grow-1">
                                        <strong>
                                            {% if address.is_default %}Home{% else %}Office{% endif %}
                                        </strong>
                                        {% if address.is_default %}
                                        <span class="address-type-badge">Default</span>
                                        {% endif %}
                                        <p class="mb-1 mt-2">{{ address.full_name }}</p>
                                        <p class="mb-1 text-muted">{{ address.address_line }}</p>
                                        <p class="mb-1 text-muted">{{ address.city }}, {{ address.state }} - {{ address.zip_code }}</p>
                                        <p class="mb-0 text-muted">Phone: {{ address.phone }}</p>
                                    </div>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            No saved addresses. Please add a new address below.
                        </div>
                    {% endif %}

                    <!-- Add New Address Button -->
                    <button type="button" class="add-address-btn" onclick="toggleAddressForm()">
                        + Add New Address
                    </button>

                    <!-- New Address Form (Hidden by default) -->
                    <div id="newAddressForm" class="address-form-container" style="display: none;">
                        <h6 class="mb-3">Add New Shipping Address</h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="fullName">Full Name *</label>
                                    <input type="text" class="form-control" id="fullName" name="fullName" placeholder="Enter full name">
                                    <small class="text-danger" id="fullNameError"></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="phone">Mobile Number *</label>
                                    <input type="text" class="form-control" id="phone" name="phone" placeholder="Enter mobile number">
                                    <small class="text-danger" id="phoneError"></small>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="address">Address Line *</label>
                            <textarea class="form-control" id="address" name="address" rows="2" placeholder="Enter address"></textarea>
                            <small class="text-danger" id="addressError"></small>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="city">City *</label>
                                    <input type="text" class="form-control" id="city" name="city" placeholder="Enter city">
                                    <small class="text-danger" id="cityError"></small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="state">State *</label>
                                    <input type="text" class="form-control" id="state" name="state" placeholder="Enter state">
                                    <small class="text-danger" id="stateError"></small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="zip">Pincode *</label>
                                    <input type="text" class="form-control" id="zip" name="zip" placeholder="Enter pincode">
                                    <small class="text-danger" id="zipError"></small>
                                </div>
                            </div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="set_as_default" id="setAsDefault">
                            <label class="form-check-label" for="setAsDefault">
                                Set as default address
                            </label>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" onclick="submitNewAddress()">
                                Save Address
                            </button>
                            <button type="button" class="btn btn-secondary ml-2" onclick="toggleAddressForm()">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <h5 class="mt-4 mb-3">Payment Method</h5>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="payment_method" id="cod" value="COD" checked>
                        <label class="form-check-label" for="cod">Cash on Delivery</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="payment_method" id="razorpay" value="RAZORPAY">
                        <label class="form-check-label" for="razorpay">Razorpay</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="payment_method" id="paypal" value="PAYPAL">
                        <label class="form-check-label" for="paypal">PayPal</label>
                    </div>
                </div>
                
                <!-- Right Column: Order Summary -->
                <div class="col-md-5">
                    <div class="order-summary p-3 bg-light rounded sticky-top" style="top: 20px;">
                        <h5>Order Summary</h5>
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span>₹{{ subtotal }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping:</span>
                            <span>₹{{ shipping_cost }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Discount:</span>
                            <span>₹{{ discount }}</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Total:</strong>
                            <strong class="text-success">₹{{ total }}</strong>
                        </div>
                        <button type="button" class="btn btn-success btn-block btn-lg" onclick="placeOrder()">
                            Place Order
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
const fields = ["fullName", "phone", "address", "city", "state", "zip"];
const rules = {
    fullName: v => v.length >= 3 || "Full name must be at least 3 characters.",
    phone: v => /^[6-9]\d{9}$/.test(v) || "Enter a valid 10-digit number starting with 6-9.",
    address: v => v.length >= 5 || "Address must be at least 5 characters.",
    city: v => v.length >= 2 || "City name must be at least 2 characters.",
    state: v => v.length >= 2 || "State name must be at least 2 characters.",
    zip: v => /^\d{6}$/.test(v) || "Pincode must be 6 digits."
};

function toggleAddressForm() {
    const form = document.getElementById('newAddressForm');
    const isHidden = form.style.display === 'none';
    form.style.display = isHidden ? 'block' : 'none';
    
    if (!isHidden) {
        // Clear form when hiding
        fields.forEach(id => {
            const input = document.getElementById(id);
            input.value = '';
            input.classList.remove('is-invalid');
            document.getElementById(id + 'Error').textContent = '';
        });
    }
}

function selectAddress(element, addressId) {
    // Remove selected class from all cards
    document.querySelectorAll('.address-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selected class to clicked card
    element.classList.add('selected');
    
    // Check the radio button
    element.querySelector('input[type="radio"]').checked = true;
}

function validateField(input) {
    let rule = rules[input.id];
    let errorDiv = document.getElementById(input.id + "Error");
    if (rule) {
        let result = rule(input.value.trim());
        if (result !== true) {
            input.classList.add("is-invalid");
            errorDiv.textContent = result;
            return false;
        } else {
            input.classList.remove("is-invalid");
            errorDiv.textContent = "";
            return true;
        }
    }
    return true;
}

function submitNewAddress() {
    let isValid = true;
    fields.forEach(id => {
        let input = document.getElementById(id);
        if (!validateField(input)) isValid = false;
    });

    if (!isValid) {
        Swal.fire({
            icon: 'error',
            title: 'Validation Error',
            text: 'Please correct the highlighted fields.'
        });
        return;
    }

    // Set action to add_address and submit
    document.getElementById('formAction').value = 'add_address';
    document.getElementById('checkoutForm').submit();
}

function placeOrder() {
    // Check if an address is selected
    const selectedAddress = document.querySelector('input[name="selected_address"]:checked');
    
    if (!selectedAddress) {
        Swal.fire({
            icon: 'warning',
            title: 'No Address Selected',
            text: 'Please select a shipping address or add a new one.'
        });
        return;
    }

    Swal.fire({
        title: 'Confirm Order?',
        text: 'Are you sure you want to place this order?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, place it!'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('formAction').value = 'place_order';
            document.getElementById('checkoutForm').submit();
        }
    });
}
</script>
</body>
</html>
{% endblock %}