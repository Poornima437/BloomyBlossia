{% extends 'user_profile/base_sidebar.html' %}
{% load static %}
{% block content %}

<div class="container py-5">
  <div class="col-md-9 offset-md-3">
    
    <!-- Change Password Form -->
    <div class="password-section">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0"><i class="fas fa-key"></i> Change Password</h4>
        <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary btn-sm">
          <i class="fas fa-arrow-left"></i> Back to Profile
        </a>
      </div>

      <!-- Security Tips -->
      <div class="alert alert-info mb-4">
        <i class="fas fa-shield-alt"></i>
        <strong>Password Security Tips:</strong>
        <ul class="mb-0 mt-2">
          <li>Use at least 8 characters with a mix of letters, numbers, and symbols</li>
          <li>Avoid common words or personal information</li>
          <li>Don't reuse passwords from other accounts</li>
        </ul>
      </div>

      <form method="POST" id="passwordChangeForm">
        {% csrf_token %}
        
        <div class="row g-4">
          
          <!-- Current Password -->
          <div class="col-12">
            <label class="form-label required">Current Password</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-lock"></i></span>
              <input type="password" 
                     name="old_password" 
                     id="oldPassword"
                     class="form-control" 
                     placeholder="Enter your current password"
                     required>
              <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('oldPassword', this)">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            {% if form.old_password.errors %}
              <small class="text-danger">{{ form.old_password.errors|striptags }}</small>
            {% endif %}
          </div>

          <!-- New Password -->
          <div class="col-12">
            <label class="form-label required">New Password</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-lock"></i></span>
              <input type="password" 
                     name="new_password1" 
                     id="newPassword1"
                     class="form-control" 
                     placeholder="Enter your new password"
                     required>
              <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('newPassword1', this)">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            {% if form.new_password1.errors %}
              <small class="text-danger">{{ form.new_password1.errors|striptags }}</small>
            {% endif %}
            
            <!-- Password Strength Indicator -->
            <div class="password-strength mt-2">
              <div class="strength-bar">
                <div class="strength-progress" id="strengthProgress"></div>
              </div>
              <small id="strengthText" class="text-muted">Password strength: <span id="strengthLevel">-</span></small>
            </div>
          </div>

          <!-- Confirm New Password -->
          <div class="col-12">
            <label class="form-label required">Confirm New Password</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-lock"></i></span>
              <input type="password" 
                     name="new_password2" 
                     id="newPassword2"
                     class="form-control" 
                     placeholder="Confirm your new password"
                     required>
              <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('newPassword2', this)">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            {% if form.new_password2.errors %}
              <small class="text-danger">{{ form.new_password2.errors|striptags }}</small>
            {% endif %}
            <small id="matchStatus" class="mt-1 d-block"></small>
          </div>

          <!-- Password Requirements -->
          <div class="col-12">
            <div class="password-requirements">
              <p class="mb-2"><strong>Password must contain:</strong></p>
              <ul class="requirements-list">
                <li id="req-length" class="requirement">
                  <i class="fas fa-circle"></i> At least 8 characters
                </li>
                <li id="req-uppercase" class="requirement">
                  <i class="fas fa-circle"></i> At least one uppercase letter
                </li>
                <li id="req-lowercase" class="requirement">
                  <i class="fas fa-circle"></i> At least one lowercase letter
                </li>
                <li id="req-number" class="requirement">
                  <i class="fas fa-circle"></i> At least one number
                </li>
                <li id="req-special" class="requirement">
                  <i class="fas fa-circle"></i> At least one special character (!@#$%^&*)
                </li>
              </ul>
            </div>
          </div>

          <!-- Submit Buttons -->
          <div class="col-12 mt-4">
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="fas fa-save"></i> Change Password
            </button>
            <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary btn-lg ms-2">
              <i class="fas fa-times"></i> Cancel
            </a>
          </div>

          <!-- Forgot Password Link -->
          <div class="col-12">
            <div class="text-center">
              <a href="{% url 'accounts:forgot_password' %}" class="text-primary">
                <i class="fas fa-question-circle"></i> Forgot your current password?
              </a>
            </div>
          </div>

        </div>
      </form>

      <!-- Recent Security Activity -->
      <div class="security-activity mt-5">
        <h6 class="mb-3"><i class="fas fa-history"></i> Recent Security Activity</h6>
        <div class="activity-item">
          <i class="fas fa-sign-in-alt text-success"></i>
          <div class="activity-details">
            <strong>Last Login</strong>
            <span class="text-muted">{{ user.last_login|date:"F d, Y - g:i A" }}</span>
          </div>
        </div>
        <div class="activity-item">
          <i class="fas fa-user-plus text-primary"></i>
          <div class="activity-details">
            <strong>Account Created</strong>
            <span class="text-muted">{{ user.date_joined|date:"F d, Y" }}</span>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
/* Password Section */
.password-section {
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  padding: 2.5rem;
  border-radius: 15px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.08);
}

/* Alert */
.alert-info {
  border-left: 4px solid #17a2b8;
  background-color: #e7f6f8;
}

.alert-info ul {
  padding-left: 1.5rem;
}

/* Labels */
label.form-label {
  font-weight: 500;
  color: #495057;
  margin-bottom: 0.5rem;
}

label.form-label.required::after {
  content: " *";
  color: #dc3545;
}

/* Input Groups */
.input-group-text {
  background-color: #69856c;
  color: white;
  border: 2px solid #69856c;
}

input.form-control {
  padding: 0.75rem 1rem;
  border: 2px solid #dee2e6;
  transition: all 0.3s ease;
}

.input-group input.form-control {
  border-left: none;
  border-right: none;
}

input.form-control:focus {
  border-color: #69856c;
  box-shadow: 0 0 0 0.2rem rgba(105, 133, 108, 0.25);
  outline: none;
}

.btn-outline-secondary {
  border: 2px solid #dee2e6;
  border-left: none;
}

/* Password Strength */
.password-strength {
  margin-top: 0.5rem;
}

.strength-bar {
  height: 8px;
  background-color: #e9ecef;
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 0.5rem;
}

.strength-progress {
  height: 100%;
  width: 0%;
  transition: all 0.3s ease;
  border-radius: 4px;
}

.strength-progress.weak {
  width: 33%;
  background-color: #dc3545;
}

.strength-progress.medium {
  width: 66%;
  background-color: #ffc107;
}

.strength-progress.strong {
  width: 100%;
  background-color: #28a745;
}

/* Password Requirements */
.password-requirements {
  background-color: #f8f9fa;
  padding: 1.5rem;
  border-radius: 10px;
  border: 2px dashed #dee2e6;
}

.requirements-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.requirement {
  padding: 0.5rem 0;
  color: #6c757d;
  transition: all 0.3s ease;
}

.requirement i {
  font-size: 0.5rem;
  margin-right: 0.5rem;
}

.requirement.met {
  color: #28a745;
}

.requirement.met i {
  color: #28a745;
}

/* Security Activity */
.security-activity {
  background-color: #f8f9fa;
  padding: 1.5rem;
  border-radius: 10px;
}

.activity-item {
  display: flex;
  align-items: center;
  padding: 1rem;
  background: white;
  border-radius: 8px;
  margin-bottom: 1rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.activity-item:last-child {
  margin-bottom: 0;
}

.activity-item i {
  font-size: 1.5rem;
  margin-right: 1rem;
}

.activity-details {
  display: flex;
  flex-direction: column;
}

.activity-details strong {
  margin-bottom: 0.25rem;
}

/* Buttons */
.btn {
  padding: 0.75rem 2rem;
  font-weight: 500;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.btn-primary {
  background-color: #69856c;
  border-color: #69856c;
}

.btn-primary:hover {
  background-color: #5a7159;
  border-color: #5a7159;
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(105, 133, 108, 0.3);
}

/* Responsive */
@media (max-width: 768px) {
  .password-section {
    padding: 1.5rem;
  }
  
  .col-md-9.offset-md-3 {
    margin-left: 0 !important;
    width: 100% !important;
  }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// Toggle password visibility
function togglePassword(inputId, button) {
  const input = document.getElementById(inputId);
  const icon = button.querySelector('i');
  
  if (input.type === 'password') {
    input.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    input.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
}

document.addEventListener('DOMContentLoaded', function() {
  const newPassword1 = document.getElementById('newPassword1');
  const newPassword2 = document.getElementById('newPassword2');
  const strengthProgress = document.getElementById('strengthProgress');
  const strengthLevel = document.getElementById('strengthLevel');
  const matchStatus = document.getElementById('matchStatus');
  const form = document.getElementById('passwordChangeForm');

  // Password strength checker
  newPassword1.addEventListener('input', function() {
    const password = this.value;
    checkPasswordStrength(password);
    checkPasswordRequirements(password);
    checkPasswordMatch();
  });

  // Password match checker
  newPassword2.addEventListener('input', function() {
    checkPasswordMatch();
  });

  function checkPasswordStrength(password) {
    let strength = 0;
    
    if (password.length >= 8) strength++;
    if (password.match(/[a-z]/)) strength++;
    if (password.match(/[A-Z]/)) strength++;
    if (password.match(/[0-9]/)) strength++;
    if (password.match(/[^a-zA-Z0-9]/)) strength++;

    strengthProgress.className = 'strength-progress';
    
    if (strength <= 2) {
      strengthProgress.classList.add('weak');
      strengthLevel.textContent = 'Weak';
      strengthLevel.style.color = '#dc3545';
    } else if (strength <= 4) {
      strengthProgress.classList.add('medium');
      strengthLevel.textContent = 'Medium';
      strengthLevel.style.color = '#ffc107';
    } else {
      strengthProgress.classList.add('strong');
      strengthLevel.textContent = 'Strong';
      strengthLevel.style.color = '#28a745';
    }
  }

  function checkPasswordRequirements(password) {
    const requirements = {
      'req-length': password.length >= 8,
      'req-uppercase': /[A-Z]/.test(password),
      'req-lowercase': /[a-z]/.test(password),
      'req-number': /[0-9]/.test(password),
      'req-special': /[!@#$%^&*(),.?":{}|<>]/.test(password)
    };

    for (const [id, met] of Object.entries(requirements)) {
      const element = document.getElementById(id);
      if (met) {
        element.classList.add('met');
      } else {
        element.classList.remove('met');
      }
    }
  }

  function checkPasswordMatch() {
    const password1 = newPassword1.value;
    const password2 = newPassword2.value;

    if (password2.length === 0) {
      matchStatus.textContent = '';
      return;
    }

    if (password1 === password2) {
      matchStatus.innerHTML = '<i class="fas fa-check-circle text-success"></i> Passwords match';
      matchStatus.className = 'text-success mt-1 d-block';
    } else {
      matchStatus.innerHTML = '<i class="fas fa-times-circle text-danger"></i> Passwords do not match';
      matchStatus.className = 'text-danger mt-1 d-block';
    }
  }

  // Form submission
  form.addEventListener('submit', function(e) {
    const password1 = newPassword1.value;
    const password2 = newPassword2.value;

    if (password1 !== password2) {
      e.preventDefault();
      Swal.fire({
        icon: 'error',
        title: 'Passwords Do Not Match',
        text: 'Please make sure both passwords are identical'
      });
      return false;
    }

    // Check if password meets all requirements
    const meetsRequirements = 
      password1.length >= 8 &&
      /[A-Z]/.test(password1) &&
      /[a-z]/.test(password1) &&
      /[0-9]/.test(password1) &&
      /[!@#$%^&*(),.?":{}|<>]/.test(password1);

    if (!meetsRequirements) {
      e.preventDefault();
      Swal.fire({
        icon: 'error',
        title: 'Weak Password',
        text: 'Please ensure your password meets all requirements'
      });
      return false;
    }
  });

  // Display messages
  {% if messages %}
    {% for message in messages %}
      Swal.fire({
        icon: '{{ message.tags }}' === 'error' ? 'error' : 'success',
        title: '{{ message.tags|title }}',
        text: '{{ message }}',
        timer: 3000
      });
    {% endfor %}
  {% endif %}

  // Display form errors
  {% if form.errors %}
    Swal.fire({
      icon: 'error',
      title: 'Form Errors',
      html: `
        {% for field, errors in form.errors.items %}
          <div class="text-start mb-2">
            <strong>{{ field|title }}:</strong> {{ errors|striptags }}
          </div>
        {% endfor %}
      `
    });
  {% endif %}
});
</script>

{% endblock %}