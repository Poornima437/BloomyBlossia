{% extends 'user_profile/base_sidebar.html' %}
{% load static %}
{% block content %}

<div class="container-fluid py-4">
  <div class="row">
    <div class="col-lg-10 col-xl-9 mx-auto">
      
      <!-- Page Header -->
      <div class="page-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h2 class="mb-1"><i class="fas fa-user-edit"></i> Edit Profile</h2>
            <p class="text-muted mb-0">Update your personal information and settings</p>
          </div>
          <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Profile
          </a>
        </div>
      </div>

      <!-- Main Form Card -->
      <div class="profile-edit-card">
        <form method="POST" enctype="multipart/form-data" id="profileForm" novalidate>
          {% csrf_token %}

          <!-- Profile Picture Section -->
          <div class="form-section">
            <div class="section-header">
              <h5><i class="fas fa-image"></i> Profile Picture</h5>
              <p class="text-muted small mb-0">Upload a professional photo</p>
            </div>
            
            <div class="profile-picture-container">
              <div class="picture-wrapper">
                <div class="picture-preview" onclick="document.getElementById('id_profile_image').click()">
                  {% if profile.profile_image %}
                    <img id="imagePreview" src="{{ profile.profile_image.url }}" alt="Profile Picture">
                  {% else %}
                    <img id="imagePreview" src="{% static 'images/default_profile.png' %}" alt="Default Avatar">
                  {% endif %}
                  <div class="picture-overlay">
                    <i class="fas fa-camera fa-2x"></i>
                    <span class="d-block mt-2">Change Photo</span>
                  </div>
                </div>
                <input type="file" 
                       name="profile_image" 
                       id="id_profile_image" 
                       accept="image/jpeg,image/jpg,image/png,image/gif"
                       class="d-none">
              </div>
              <div class="picture-info">
                <button type="button" class="btn btn-primary btn-sm mb-2" onclick="document.getElementById('id_profile_image').click()">
                  <i class="fas fa-upload"></i> Upload New Photo
                </button>
                <p class="text-muted small mb-0">
                  <i class="fas fa-info-circle"></i> JPG, PNG or GIF • Max 5MB • Recommended: 400x400px
                </p>
              </div>
            </div>
          </div>

          <!-- Personal Information Section -->
          <div class="form-section">
            <div class="section-header">
              <h5><i class="fas fa-user"></i> Personal Information</h5>
              <p class="text-muted small mb-0">Basic details about you</p>
            </div>

            <div class="row g-3">
              <!-- First Name -->
              <div class="col-md-6">
                <label for="id_first_name" class="form-label required">First Name</label>
                <div class="input-icon-wrapper">
                  <i class="fas fa-user input-icon"></i>
                  <input type="text" 
                         class="form-control" 
                         id="id_first_name"
                         name="first_name" 
                         value="{{ user.username }}"
                         placeholder="Enter your first name"
                         required>
                </div>
              </div>

              <!-- Last Name -->
              <div class="col-md-6">
                <label for="id_last_name" class="form-label required">Last Name</label>
                <div class="input-icon-wrapper">
                  <i class="fas fa-user input-icon"></i>
                  <input type="text" 
                         class="form-control" 
                         id="id_last_name"
                         name="last_name" 
                         value="{{ user.last_name }}"
                         placeholder="Enter your last name"
                         required>
                </div>
                <div class="invalid-feedback">Last name is required</div>
              </div>

              <!-- Email -->
              <div class="col-md-6">
                <label for="id_email" class="form-label required">Email Address</label>
                <div class="input-icon-wrapper">
                  <i class="fas fa-envelope input-icon"></i>
                  <input type="email" 
                         class="form-control" 
                         id="id_email"
                         name="email" 
                         value="{{ user.email }}"
                         data-original-email="{{ user.email }}"
                         placeholder="your.email@example.com"
                         required>
                </div>
                <div class="email-status-badge mt-2">
                  {% if profile.email_verified %}
                    <span class="badge bg-success">
                      <i class="fas fa-check-circle"></i> Email Verified
                    </span>
                  {% else %}
                    <span class="badge bg-warning text-dark">
                      <i class="fas fa-exclamation-triangle"></i> Email Not Verified
                    </span>
                  {% endif %}
                </div>
                <small class="form-text text-muted d-block mt-1">
                  <i class="fas fa-info-circle"></i> Changing email requires OTP verification
                </small>
                <div class="invalid-feedback">Please enter a valid email address</div>
              </div>

              <!-- Phone Number -->
              <div class="col-md-6">
                <label for="id_phone" class="form-label">Phone Number</label>
                <div class="input-icon-wrapper">
                  <i class="fas fa-phone input-icon"></i>
                  <input type="tel" 
                         class="form-control" 
                         id="id_phone"
                         name="phone" 
                         value="{{ profile.phone|default:'' }}"
                         placeholder="+1 (555) 123-4567"
                         pattern="[0-9+\-\s\(\)]+">
                </div>
                <small class="form-text text-muted">Format: +1234567890 or (123) 456-7890</small>
                <div class="invalid-feedback">Please enter a valid phone number</div>
              </div>
            </div>

            <!-- Current Data Info Notice -->
            <div class="alert alert-info mt-3 mb-0" role="alert">
              <i class="fas fa-info-circle"></i>
              <strong>Note:</strong> Your current information is pre-filled in the form. Make changes as needed and click "Save Changes" to update your profile.
            </div>
          </div>

          <!-- About Section -->
          <div class="form-section">
            <div class="section-header">
              <h5><i class="fas fa-info-circle"></i> About You</h5>
              <p class="text-muted small mb-0">Tell us more about yourself</p>
            </div>

            <div class="row g-3">
              <div class="col-12">
                <label for="id_bio" class="form-label">Bio</label>
                <textarea class="form-control" 
                          id="id_bio"
                          name="bio" 
                          rows="4" 
                          maxlength="500"
                          placeholder="Write a short bio about yourself...">{{ profile.bio|default:'' }}</textarea>
                <div class="character-count mt-1">
                  <small class="text-muted">
                    <span id="charCount">0</span>/500 characters
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="form-actions">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
              <div class="d-flex gap-2 flex-wrap">
                <button type="submit" class="btn btn-primary btn-lg">
                  <i class="fas fa-save"></i> Save Changes
                </button>
                <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary btn-lg">
                  <i class="fas fa-times"></i> Cancel
                </a>
              </div>
              <a href="{% url 'accounts:change_password' %}" class="btn btn-danger btn-lg">
                <i class="fas fa-key"></i> Change Password
              </a>
            </div>
          </div>

        </form>
      </div>

    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  <div id="toastMessage" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        <i class="toast-icon"></i>
        <span class="toast-text"></span>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<style>
/* ======================
   Page Layout
====================== */
.page-header {
  background: linear-gradient(135deg, #3a7d4e 0%, #0d8b0d 100%);
  padding: 2rem;
  border-radius: 15px;
  color: white;
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
}

.page-header h2 {
  font-weight: 700;
  margin: 0;
}

.page-header .btn-outline-secondary {
  background: rgba(255, 255, 255, 0.2);
  border-color: white;
  color: white;
  backdrop-filter: blur(10px);
}

.page-header .btn-outline-secondary:hover {
  background: white;
  color: #4d9142;
}

/* ======================
   Main Card
====================== */
.profile-edit-card {
  background: white;
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
  overflow: hidden;
}

/* ======================
   Form Sections
====================== */
.form-section {
  padding: 2.5rem;
  border-bottom: 1px solid #e9ecef;
}

.form-section:last-child {
  border-bottom: none;
}

.section-header {
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 3px solid #f0f0f0;
}

.section-header h5 {
  font-weight: 700;
  color: #2d3748;
  margin-bottom: 0.5rem;
  font-size: 1.25rem;
}

.section-header h5 i {
  color: #287835;
  margin-right: 0.5rem;
}

/* ======================
   Form Labels & Inputs
====================== */
.form-label {
  font-weight: 600;
  color: #4a5568;
  margin-bottom: 0.5rem;
  font-size: 0.95rem;
}

.form-label.required::after {
  content: " *";
  color: #e53e3e;
  font-weight: 700;
}

.input-icon-wrapper {
  position: relative;
}

.input-icon {
  position: absolute;
  left: 15px;
  top: 50%;
  transform: translateY(-50%);
  color: #297721;
  z-index: 10;
  font-size: 1rem;
}

.input-icon-wrapper .form-control {
  padding-left: 45px;
}

.form-control {
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  padding: 0.75rem 1rem;
  font-size: 0.95rem;
  transition: all 0.3s ease;
  background: #f8f9fa;
}

.form-control:focus {
  border-color: #139a49;
  background: white;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
  outline: none;
}

.form-control::placeholder {
  color: #a0aec0;
}

textarea.form-control {
  resize: vertical;
  min-height: 120px;
}

select.form-control {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23667eea' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 1rem center;
  background-size: 16px 12px;
  padding-right: 2.5rem;
}

.form-text {
  font-size: 0.85rem;
  margin-top: 0.25rem;
}

/* ======================
   Validation Feedback
====================== */
.invalid-feedback {
  display: none;
  color: #e53e3e;
  font-size: 0.875rem;
  margin-top: 0.5rem;
  padding: 0.5rem 0.75rem;
  background: #fff5f5;
  border-left: 3px solid #e53e3e;
  border-radius: 5px;
}

.form-control.is-invalid {
  border-color: #e53e3e;
  background: #fff5f5;
}

.form-control.is-invalid ~ .invalid-feedback {
  display: block;
}

.form-control.is-valid {
  border-color: #48bb78;
  background: #f0fff4;
}

/* ======================
   Profile Picture
====================== */
.profile-picture-container {
  display: flex;
  align-items: center;
  gap: 2rem;
  flex-wrap: wrap;
}

.picture-wrapper {
  flex-shrink: 0;
}

.picture-preview {
  width: 180px;
  height: 180px;
  border-radius: 50%;
  overflow: hidden;
  position: relative;
  cursor: pointer;
  border: 5px solid #1f9029;
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
  transition: all 0.3s ease;
}

.picture-preview:hover {
  transform: scale(1.05);
  box-shadow: 0 12px 32px rgba(39, 154, 49, 0.3);
}

.picture-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.picture-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(25, 144, 31, 0.9);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
  color: white;
}

.picture-preview:hover .picture-overlay {
  opacity: 1;
}

.picture-overlay span {
  font-size: 0.9rem;
  font-weight: 600;
}

.picture-info {
  flex: 1;
}

/* ======================
   Email Status Badge
====================== */
.email-status-badge .badge {
  font-size: 0.85rem;
  padding: 0.5rem 0.75rem;
  font-weight: 600;
}

/* ======================
   Character Count
====================== */
.character-count {
  text-align: right;
}

#charCount {
  font-weight: 600;
  color: #3d9f27;
}

/* ======================
   Action Buttons
====================== */
.form-actions {
  padding: 2rem 2.5rem;
  background: #f8f9fa;
  border-top: 3px solid #e9ecef;
}

.btn {
  font-weight: 600;
  padding: 0.75rem 2rem;
  border-radius: 10px;
  transition: all 0.3s ease;
  border: none;
}

.btn-primary {
  background: linear-gradient(135deg, #2e743e 0%, #31bf35 100%);
  color: white;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.btn-outline-secondary {
  background: white;
  border: 2px solid #cbd5e0;
  color: #4a5568;
}

.btn-outline-secondary:hover {
  background: #f7fafc;
  border-color: #a0aec0;
}

.btn-danger {
  background: linear-gradient(135deg, #5e97af 0%, #426299 100%);
  color: white;
  box-shadow: 0 4px 15px rgba(40, 208, 113, 0.3);
}

.btn-danger:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(245, 101, 101, 0.4);
}

/* ======================
   Toast Notifications
====================== */
.toast {
  min-width: 350px;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  backdrop-filter: blur(10px);
}

.toast-body {
  padding: 1rem 1.25rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-weight: 500;
}

.toast-icon {
  font-size: 1.5rem;
}

.toast-text {
  flex: 1;
}

.toast.toast-success {
  background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
  color: white;
}

.toast.toast-error {
  background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
  color: white;
}

.toast.toast-warning {
  background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
  color: white;
}

.toast.toast-info {
  background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
  color: white;
}

/* ======================
   Responsive Design
====================== */
@media (max-width: 768px) {
  .page-header {
    padding: 1.5rem;
  }

  .page-header .d-flex {
    flex-direction: column;
    gap: 1rem;
    align-items: flex-start !important;
  }

  .form-section {
    padding: 1.5rem;
  }

  .profile-picture-container {
    flex-direction: column;
    text-align: center;
  }

  .picture-info {
    width: 100%;
  }

  .form-actions {
    padding: 1.5rem;
  }

  .form-actions .d-flex {
    flex-direction: column;
    width: 100%;
  }

  .form-actions .btn {
    width: 100%;
  }

  .toast {
    min-width: 300px;
  }
}

@media (max-width: 576px) {
  .picture-preview {
    width: 140px;
    height: 140px;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // ==============================================
    // TOAST NOTIFICATION SYSTEM
    // ==============================================
    function showToast(message, type = 'info', duration = 5000) {
        const toastEl = document.getElementById('toastMessage');
        const toastBody = toastEl.querySelector('.toast-body');
        const toastIcon = toastEl.querySelector('.toast-icon');
        const toastText = toastEl.querySelector('.toast-text');

        // Set icon based on type
        const icons = {
            success: 'fas fa-check-circle',
            error: 'fas fa-exclamation-circle',
            warning: 'fas fa-exclamation-triangle',
            info: 'fas fa-info-circle'
        };

        // Reset classes
        toastEl.className = 'toast align-items-center border-0';
        toastEl.classList.add(`toast-${type}`);
        
        // Set content
        toastIcon.className = `toast-icon ${icons[type]}`;
        toastText.textContent = message;

        // Show toast
        const toast = new bootstrap.Toast(toastEl, {
            autohide: true,
            delay: duration
        });
        toast.show();
    }

    // ==============================================
    // DISPLAY DJANGO MESSAGES AS TOASTS
    // ==============================================
    {% if messages %}
        {% for message in messages %}
            showToast(
                "{{ message|escapejs }}", 
                "{{ message.tags }}",
                5000
            );
        {% endfor %}
    {% endif %}

    // ==============================================
    // FORM ELEMENTS
    // ==============================================
    const form = document.getElementById('profileForm');
    const emailInput = document.getElementById('id_email');
    const originalEmail = emailInput.dataset.originalEmail;
    const bioTextarea = document.getElementById('id_bio');
    const charCount = document.getElementById('charCount');
    const imageInput = document.getElementById('id_profile_image');
    const imagePreview = document.getElementById('imagePreview');

    // ==============================================
    // IMAGE PREVIEW FUNCTIONALITY
    // ==============================================
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        
        if (!file) return;

        // Validate file type
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        if (!validTypes.includes(file.type)) {
            showToast('Please select a valid image file (JPG, PNG, or GIF)', 'error');
            this.value = '';
            return;
        }

        // Validate file size (5MB)
        const maxSize = 5 * 1024 * 1024; // 5MB in bytes
        if (file.size > maxSize) {
            showToast('Image size must be less than 5MB', 'error');
            this.value = '';
            return;
        }

        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            imagePreview.src = e.target.result;
            showToast('Image selected successfully. Remember to save changes!', 'info');
        };
        reader.readAsDataURL(file);
    });

    // ==============================================
    // CHARACTER COUNTER FOR BIO
    // ==============================================
    function updateCharCount() {
        const currentLength = bioTextarea.value.length;
        charCount.textContent = currentLength;
        
        if (currentLength > 450) {
            charCount.style.color = '#e53e3e';
        } else if (currentLength > 400) {
            charCount.style.color = '#ed8936';
        } else {
            charCount.style.color = '#667eea';
        }
    }

    bioTextarea.addEventListener('input', updateCharCount);
    updateCharCount(); // Initial count

    // ==============================================
    // FORM VALIDATION
    // ==============================================
    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    function validatePhone(phone) {
        if (!phone) return true; // Phone is optional
        const re = /^[0-9+\-\s\(\)]+$/;
        return re.test(phone) && phone.length >= 10;
    }

    function validateField(field) {
        const value = field.value.trim();
        const fieldName = field.name;
        let isValid = true;
        let errorMessage = '';

        // Required fields validation
        if (field.hasAttribute('required') && !value) {
            isValid = false;
            errorMessage = `${field.previousElementSibling.textContent.replace('*', '').trim()} is required`;
        }
        // Email validation
        else if (fieldName === 'email' && !validateEmail(value)) {
            isValid = false;
            errorMessage = 'Please enter a valid email address';
        }
        // Phone validation
        else if (fieldName === 'phone' && value && !validatePhone(value)) {
            isValid = false;
            errorMessage = 'Please enter a valid phone number';
        }

        // Update UI
        if (!isValid) {
            field.classList.add('is-invalid');
            field.classList.remove('is-valid');
            const feedback = field.parentElement.nextElementSibling;
            if (feedback && feedback.classList.contains('invalid-feedback')) {
                feedback.textContent = errorMessage;
            }
        } else {
            field.classList.remove('is-invalid');
            if (value) {
                field.classList.add('is-valid');
            }
        }

        return isValid;
    }

    // Real-time validation
    const formInputs = form.querySelectorAll('input[required], input[type="email"], input[type="tel"]');
    formInputs.forEach(input => {
        input.addEventListener('blur', function() {
            validateField(this);
        });

        input.addEventListener('input', function() {
            if (this.classList.contains('is-invalid')) {
                validateField(this);
            }
        });
    });

    // ==============================================
    // EMAIL CHANGE DETECTION
    // ==============================================
    let emailChanged = false;

    emailInput.addEventListener('input', function() {
        emailChanged = this.value.trim() !== originalEmail;
        
        if (emailChanged) {
            showToast(
                'Email changed. You will need to verify the new email via OTP after saving.',
                'info',
                4000
            );
        }
    });

    // ==============================================
    // FORM SUBMISSION
    // ==============================================
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Validate all required fields
        let isValid = true;
        const errors = [];

        // Validate first name
        const firstName = document.getElementById('id_first_name');
        if (!firstName.value.trim()) {
            isValid = false;
            errors.push('First name is required');
            firstName.classList.add('is-invalid');
        }

        // Validate last name
        const lastName = document.getElementById('id_last_name');
        if (!lastName.value.trim()) {
            isValid = false;
            errors.push('Last name is required');
            lastName.classList.add('is-invalid');
        }

        // Validate email
        const email = document.getElementById('id_email');
        if (!email.value.trim()) {
            isValid = false;
            errors.push('Email is required');
            email.classList.add('is-invalid');
        } else if (!validateEmail(email.value.trim())) {
            isValid = false;
            errors.push('Please enter a valid email address');
            email.classList.add('is-invalid');
        }

        // Validate phone if provided
        const phone = document.getElementById('id_phone');
        if (phone.value.trim() && !validatePhone(phone.value.trim())) {
            isValid = false;
            errors.push('Please enter a valid phone number');
            phone.classList.add('is-invalid');
        }

        // If validation fails, show errors
        if (!isValid) {
            errors.forEach((error, index) => {
                setTimeout(() => {
                    showToast(error, 'error', 5000);
                }, index * 300);
            });
            
            // Scroll to first error
            const firstInvalid = form.querySelector('.is-invalid');
            if (firstInvalid) {
                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalid.focus();
            }
            
            return false;
        }

        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

        // If email changed, warn user about verification
        if (emailChanged) {
            showToast(
                'Saving changes... You will be redirected to verify your new email.',
                'info',
                3000
            );
        } else {
            showToast('Saving your profile changes...', 'info', 2000);
        }

        // Submit the form
        setTimeout(() => {
            form.submit();
        }, 500);
    });

    // ==============================================
    // UNSAVED CHANGES WARNING
    // ==============================================
    let formModified = false;

    form.addEventListener('change', function() {
        formModified = true;
    });

    form.addEventListener('submit', function() {
        formModified = false;
    });

    window.addEventListener('beforeunload', function(e) {
        if (formModified) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        }
    });

    // ==============================================
    // PREVENT MULTIPLE FORM SUBMISSIONS
    // ==============================================
    let isSubmitting = false;

    form.addEventListener('submit', function(e) {
        if (isSubmitting) {
            e.preventDefault();
            showToast('Please wait, form is being submitted...', 'warning');
            return false;
        }
        isSubmitting = true;
    });

    // ==============================================
    // SMOOTH SCROLL TO SECTIONS
    // ==============================================
    const sectionHeaders = document.querySelectorAll('.section-header');
    sectionHeaders.forEach(header => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function() {
            this.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    });

    // ==============================================
    // KEYBOARD SHORTCUTS
    // ==============================================
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + S to save
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            form.requestSubmit();
        }
        
        // Escape to cancel
        if (e.key === 'Escape') {
            const cancelBtn = document.querySelector('a[href*="profile"]');
            if (cancelBtn && formModified) {
                if (confirm('You have unsaved changes. Are you sure you want to cancel?')) {
                    window.location.href = cancelBtn.href;
                }
            } else if (cancelBtn) {
                window.location.href = cancelBtn.href;
            }
        }
    });

    // ==============================================
    // INITIALIZE TOOLTIPS (if Bootstrap tooltips are needed)
    // ==============================================
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // ==============================================
    // AUTO-SAVE DRAFT (Optional - to localStorage)
    // ==============================================
    function saveDraft() {
        const formData = {
            firstName: document.getElementById('id_first_name').value,
            lastName: document.getElementById('id_last_name').value,
            phone: document.getElementById('id_phone').value,
            address: document.getElementById('id_address').value,
            city: document.getElementById('id_city').value,
            state: document.getElementById('id_state').value,
            bio: document.getElementById('id_bio').value,
            timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('profileEditDraft', JSON.stringify(formData));
    }

    function loadDraft() {
        const draft = localStorage.getItem('profileEditDraft');
        if (draft) {
            try {
                const data = JSON.parse(draft);
                const draftAge = new Date() - new Date(data.timestamp);
                
                // Only load draft if it's less than 24 hours old
                if (draftAge < 24 * 60 * 60 * 1000) {
                    if (confirm('A draft of your profile edits was found. Would you like to restore it?')) {
                        document.getElementById('id_first_name').value = data.firstName || '';
                        document.getElementById('id_last_name').value = data.lastName || '';
                        document.getElementById('id_phone').value = data.phone || '';
                        document.getElementById('id_address').value = data.address || '';
                        document.getElementById('id_city').value = data.city || '';
                        document.getElementById('id_state').value = data.state || '';
                        document.getElementById('id_bio').value = data.bio || '';
                        
                        updateCharCount();
                        showToast('Draft restored successfully!', 'success');
                    } else {
                        localStorage.removeItem('profileEditDraft');
                    }
                } else {
                    localStorage.removeItem('profileEditDraft');
                }
            } catch (e) {
                console.error('Error loading draft:', e);
                localStorage.removeItem('profileEditDraft');
            }
        }
    }

    // Load draft on page load
    loadDraft();

    // Auto-save draft every 30 seconds
    setInterval(function() {
        if (formModified) {
            saveDraft();
        }
    }, 30000);

    // Clear draft on successful submission
    form.addEventListener('submit', function() {
        localStorage.removeItem('profileEditDraft');
    });

    // ==============================================
    // FIELD FOCUS EFFECTS
    // ==============================================
    const allInputs = form.querySelectorAll('.form-control');
    allInputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.parentElement.style.transform = 'scale(1.01)';
            this.parentElement.style.transition = 'transform 0.2s ease';
        });

        input.addEventListener('blur', function() {
            this.parentElement.style.transform = 'scale(1)';
        });
    });

    // ==============================================
    // INITIALIZATION MESSAGE
    // ==============================================
    console.log('%c✨ Profile Edit Page Loaded Successfully!', 'color: #667eea; font-size: 16px; font-weight: bold;');
    console.log('%cKeyboard Shortcuts:', 'color: #4a5568; font-weight: bold;');
    console.log('  • Ctrl/Cmd + S: Save changes');
    console.log('  • Escape: Cancel (with confirmation if changes made)');

});
</script>
{% endblock %}